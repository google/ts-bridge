steps:

# Get the release tags from git
- name: gcr.io/cloud-builders/git
  args: [fetch, --depth=100, --tags]

- name: 'gcr.io/cloud-builders/git'
  id: 'Setup tags'
  entrypoint: '/bin/bash'
  args: ['-c', 'git describe --abbrev=0 --tags > _FULL_TAG; echo $(cat _FULL_TAG)']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build image with custom tags'
  entrypoint: '/bin/bash'
  args:
  - '-ceux'
  - |
    docker build -t gcr.io/$PROJECT_ID/ts-bridge:$SHORT_SHA \
      -t gcr.io/$PROJECT_ID/ts-bridge:$BUILD_ID \
      -t gcr.io/$PROJECT_ID/ts-bridge:$$(cat _FULL_TAG) \
      -t gcr.io/$PROJECT_ID/ts-bridge:$$(date -u +%Y%m%dT%H%M) \
      .

# - name: 'gcr.io/cloud-builders/docker'
#   id: 'Push image with all tags'
#   args:
#   - 'push'
#   - 'gcr.io/$PROJECT_ID/ts-bridge'

# TODO: Add major and minor tags
images:
- gcr.io/$PROJECT_ID/ts-bridge