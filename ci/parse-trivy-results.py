"""Script to parse results from Trivy scan.

1) Reads in results from two files (json and table format) generated by Trivy.
2) Creates a GitHub issue in the given repo if any vulnerabilities were found.
3) Fails the CI build if any vulerabilities of HIGH/CRITICAL severity exist.

Both the json and table Trivy results must be created prior to running
this script. These can be generated with:
    trivy image --format json --light --no-progress -o <trivy_output>.json
        gcr.io/cre-tools/ts-bridge
    trivy image --light  --no-progress -o <trivy_output>.table
        gcr.io/cre-tools/ts-bridge

Usage:
    python3 parse-trivy-results.py <trivy_output> <commit_id> <build_id> <release_tag> <repo_name> <token_file>

Example usage:
    python3 parse-trivy-results.py trivy-out 99637b2 c933bec7-9acd-48e2-bd7f-7ed7251b5792 1.1.1 google/ts-bridge git_token.txt

"""
import json
import sys
from github import Github

CMDLINE_ARGS = 7

def load_results():
    """ Load the results from Trivy."""
    trivy_out_json = "{}.json".format(sys.argv[1])
    trivy_out_table = "{}.table".format(sys.argv[1])
    print(trivy_out_table, trivy_out_json)
    try:
        with open(trivy_out_json) as f:
            # Index is 0 because there is only one target built.
            trivy_result = json.load(f)[0]
        with open(trivy_out_table) as f:
            trivy_table = f.read()
    except FileNotFoundError:
        error = ("Please run \n"
                "trivy image --format json --light --no-progress -o {} "
                "gcr.io/cre-tools/ts-bridge \n"
                "trivy image --light  --no-progress -o {} "
                "gcr.io/cre-tools/ts-bridge \n"
                ).format(trivy_out_json, trivy_out_table)
        sys.exit(error)
    return [trivy_result, trivy_table]

def get_severity_list(vulnerabilities):
    """Filters out all the severities in a given list of vulnerabilities."""
    severity_list = [v.get('Severity') for v in vulnerabilities]
    return sorted(set(severity_list))

def get_github_repo():
    """Connects to GitHub API and returns a repo object."""
    repo_name = sys.argv[5]
    with open(sys.argv[6]) as f:
        token = f.read()
    github = Github(token)
    return github.get_repo(repo_name)

def create_issue(target_name, num_vulnerabilities, severity_list, table):
    """Creates a Github issue with vulnerabilities as description."""
    commit_id = sys.argv[2]
    build_id = sys.argv[3]
    release_tag = sys.argv[4]
    repo = get_github_repo()

    title = ("Vulnerability [{}] found in {}: Images from commit {} cannot be "
             "released").format(",".join(severity_list), release_tag, commit_id)

    intro = ("Trivy has detected {} vulnerabilities in your latest "
             "build. Please correct this issue so the new images can be "
             "published on Container Registry.\n").format(num_vulnerabilities)
    body = [intro]
    body.append("**Cloud Build ID:** {}".format(build_id))
    body.append("**Commit ID:** {}".format(commit_id))
    body.append("**Tag:** {}".format(release_tag))
    body.append("**Target:** {}".format(target_name))
    body.append("```")
    body.append(table)
    body.append("```")
    body = "\n".join(body)

    new_issue = repo.create_issue(title=title, body=body)
    return new_issue.number

def check_cmdline_args():
    if len(sys.argv) != CMDLINE_ARGS:
        print(len(sys.argv))
        debug_msg = ("Usage: python3 parse-trivy-results.py <TRIVY_FILE> "
                     "<commit_id> <build_id> <release_tag> <repo_name> "
                     "<TOKEN_FILE>")
        sys.exit(debug_msg)

def main():
    check_cmdline_args()

    [trivy_result, trivy_table] = load_results()

    # Examine results to check if vulnerabilities were found
    target = trivy_result["Target"]
    vulnerabilities = trivy_result["Vulnerabilities"]
    if vulnerabilities:
        num_vulnerabilities = len(vulnerabilities)
        severity_list = get_severity_list(vulnerabilities)
        issue_number = create_issue(target, num_vulnerabilities,
                                    severity_list, trivy_table)

        debug_msg = ("{} vulnerabilities of type: [{}] were found in image. "
                     "Please refer to issue: {} for details."
                    ).format(num_vulnerabilities, ",".join(severity_list),
                             issue_number)
        print(debug_msg)

        if "HIGH" in severity_list or "CRITICAL" in severity_list:
            sys.exit("Build will be aborted and "
                     "new images will not be pushed to GCR.")
        else:
            print("Images will be published to GCR.")
    else:
        print("No vulnerabilities found. Images will be published to GCR.")

if __name__ == '__main__':
    main()
